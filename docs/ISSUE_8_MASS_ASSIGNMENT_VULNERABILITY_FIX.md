# Issue #8: Mass Assignment Vulnerability Fix

## Overview
Fixed HIGH severity mass assignment vulnerability in workspace-owned serializers where system-managed fields (`workspace`, `created_by`, timestamps) were writable through API requests, potentially allowing authorization bypass and user impersonation attacks.

## Severity Assessment
**HIGH** - Security issue allowing:
- Workspace bypass (users could assign objects to arbitrary workspaces)
- User impersonation (users could set `created_by` to impersonate other users)
- Authorization bypass via mass assignment
- Audit trail manipulation

## Vulnerability Type
- **CWE-915**: Improperly Controlled Modification of Dynamically-Determined Object Attributes
- **OWASP**: Mass Assignment
- **Attack Vector**: HTTP POST/PATCH/PUT requests with malicious field values

## Vulnerable Code (Before Fix)

### Example: DimensionSerializer
```python
class DimensionSerializer(serializers.ModelSerializer):
    class Meta:
        model = models.Dimension
        fields = [
            "id",
            "name",
            # ...
            "workspace",   # ❌ WRITABLE - Mass assignment vulnerability!
            "created_by",  # ❌ WRITABLE - User impersonation vulnerability!
            "created",
            "last_updated",
        ]
        extra_kwargs = {
            'workspace': {'required': True, 'allow_null': False},  # Still writable!
        }
```

### Attack Scenarios

#### Scenario 1: Workspace Bypass Attack
```bash
# Attacker creates dimension in unauthorized workspace
POST /api/v1/workspaces/123/dimensions/
{
    "name": "Malicious Dimension",
    "type": "list",
    "workspace": 456  # ❌ Different workspace ID - bypass!
}
```

**Impact**: Attacker can create objects in workspaces they don't have access to

#### Scenario 2: User Impersonation Attack
```bash
# Attacker sets created_by to admin user
POST /api/v1/workspaces/123/dimensions/
{
    "name": "Fake Admin Dimension",
    "type": "list",
    "created_by": 1  # ❌ Admin user ID - impersonation!
}
```

**Impact**: Objects appear to be created by admin in audit logs

#### Scenario 3: Timestamp Manipulation
```bash
# Attacker manipulates timestamps
POST /api/v1/workspaces/123/dimensions/
{
    "name": "Backdated Dimension",
    "type": "list",
    "created": "2020-01-01T00:00:00Z",  # ❌ Fake timestamp
    "last_updated": "2020-01-01T00:00:00Z"
}
```

**Impact**: Audit trail manipulation, compliance violations

## Affected Serializers

1. ✅ **DimensionSerializer** - Fixed
2. ✅ **DimensionValueSerializer** - Fixed
3. ✅ **RuleCreateUpdateSerializer** - Fixed
4. ✅ **StringWithDetailsSerializer** - Fixed

## Solution Implemented

### Defense-in-Depth Approach

#### Layer 1: Base Serializer Class
Created `WorkspaceOwnedSerializer` base class that defines read-only fields:

**File**: `master_data/serializers/base.py`

```python
class WorkspaceOwnedSerializer(serializers.ModelSerializer):
    """
    Base serializer for models that belong to a workspace.

    Implements security best practices:
    - Prevents mass assignment to workspace field
    - Prevents mass assignment to created_by field
    - Prevents modification of timestamps
    """

    class Meta:
        # These fields should be read-only across all workspace-owned models
        read_only_fields = [
            'id',
            'workspace',      # Set by view from URL path
            'created_by',     # Set by view from request.user
            'created',        # Auto-managed timestamp
            'last_updated',   # Auto-managed timestamp
        ]
```

#### Layer 2: Serializer Inheritance
Updated all workspace-owned serializers to inherit from base class:

**File**: `master_data/serializers/dimension.py`

```python
from .base import WorkspaceOwnedSerializer

class DimensionSerializer(WorkspaceOwnedSerializer):
    # ...

    class Meta(WorkspaceOwnedSerializer.Meta):
        model = models.Dimension
        fields = [
            "id",
            "name",
            "slug",
            # ...
            "workspace",      # ✅ Now read-only (inherited)
            "created_by",     # ✅ Now read-only (inherited)
            "created",        # ✅ Now read-only (inherited)
            "last_updated",   # ✅ Now read-only (inherited)
        ]
        # Extend parent read_only_fields with slug (auto-generated)
        read_only_fields = WorkspaceOwnedSerializer.Meta.read_only_fields + ['slug']
```

#### Layer 3: View Enforcement
Ensured views explicitly set system fields in `perform_create`:

**File**: `master_data/views/dimension_views.py`

```python
def perform_create(self, serializer):
    """Set workspace and created_by when creating objects."""
    workspace_id = self.kwargs.get('workspace_id')
    kwargs = {}

    if workspace_id:
        workspace = models.Workspace.objects.get(id=workspace_id)
        kwargs['workspace'] = workspace

    # Set created_by if user is authenticated
    if hasattr(self.request, 'user') and self.request.user.is_authenticated:
        kwargs['created_by'] = self.request.user

    serializer.save(**kwargs)
```

## Files Created

### 1. `master_data/serializers/base.py` (New File)
- Created `WorkspaceOwnedSerializer` base class
- Defines common read_only_fields for all workspace-owned models
- Includes comprehensive documentation

### 2. `master_data/tests/test_mass_assignment_prevention.py` (New File)
- Created 12 comprehensive tests for mass assignment prevention
- Tests all affected serializers
- Tests API endpoints
- Tests base serializer functionality

## Files Modified

### 1. `master_data/serializers/dimension.py`
**Changes**:
- Added import for `WorkspaceOwnedSerializer`
- Changed `DimensionSerializer` to inherit from `WorkspaceOwnedSerializer`
- Updated Meta class to inherit from `WorkspaceOwnedSerializer.Meta`
- Added `read_only_fields` extending parent with `slug`
- Removed redundant `workspace` from `extra_kwargs`
- Applied same changes to `DimensionValueSerializer`

### 2. `master_data/serializers/rule.py`
**Changes**:
- Added import for `WorkspaceOwnedSerializer`
- Changed `RuleCreateUpdateSerializer` to inherit from `WorkspaceOwnedSerializer`
- Updated Meta class to inherit from `WorkspaceOwnedSerializer.Meta`
- Added `read_only_fields` extending parent with `slug`
- Removed redundant `workspace` from `extra_kwargs`

### 3. `master_data/serializers/string.py`
**Changes**:
- Added import for `WorkspaceOwnedSerializer`
- Changed `StringWithDetailsSerializer` to inherit from `WorkspaceOwnedSerializer`
- Updated Meta class to inherit from `WorkspaceOwnedSerializer.Meta`
- Added `read_only_fields` extending parent with `version`
- Removed redundant fields from previous `read_only_fields`

### 4. `master_data/views/dimension_views.py`
**Changes**:
- Updated `perform_create()` to explicitly set both `workspace` and `created_by`
- Ensures proper field assignment even when `WorkspaceValidationMixin` is overridden

## Test Results

### New Tests (12/12 Passing) ✅

```bash
python manage.py test master_data.tests.test_mass_assignment_prevention

✅ test_all_workspace_serializers_inherit_from_base
✅ test_workspace_owned_serializer_has_read_only_fields
✅ test_cannot_assign_to_different_workspace_via_api
✅ test_cannot_modify_workspace_via_update
✅ test_cannot_set_created_by_via_api
✅ test_created_by_field_is_read_only
✅ test_workspace_field_is_read_only
✅ test_cannot_assign_dimension_value_to_different_workspace
✅ test_cannot_set_created_by_for_dimension_value
✅ test_dimension_value_serializer_has_read_only_fields
✅ test_rule_serializer_has_read_only_fields
✅ test_string_serializer_has_read_only_fields

Ran 12 tests in 5.756s - OK
```

### Existing Tests (44/44 Still Passing) ✅

```bash
python manage.py test master_data.tests.test_workspace_isolation \
                       master_data.tests.test_query_optimization \
                       master_data.tests.test_dimension_validation \
                       master_data.tests.test_string_serializer_workspace_isolation

Ran 44 tests - OK
```

### Total: 56/56 tests passing ✅

## Security Impact

### Before Fix
- ❌ Users could assign objects to arbitrary workspaces
- ❌ Users could impersonate other users via created_by
- ❌ Users could manipulate timestamps
- ❌ Authorization bypass via mass assignment
- ❌ Audit trail could be falsified

### After Fix
- ✅ Workspace field is read-only (set by view from URL)
- ✅ created_by field is read-only (set by view from authenticated user)
- ✅ Timestamps are read-only (managed by Django)
- ✅ Mass assignment attacks prevented
- ✅ Audit trail integrity preserved

## Benefits

### 1. Defense in Depth
- **Layer 1**: Serializer prevents accepting malicious fields
- **Layer 2**: View explicitly sets trusted values
- **Layer 3**: Database constraints enforce integrity

### 2. Code Reusability
- Single base class defines security policy
- All workspace-owned serializers inherit protection
- Consistent behavior across all models

### 3. Maintainability
- One place to update security policy
- Clear inheritance hierarchy
- Well-documented base class

### 4. Compliance
- Preserves audit trail integrity
- Prevents authorization bypass
- Maintains multi-tenant isolation

## Test Coverage

### Test Categories

#### 1. Serializer-Level Tests (4 tests)
- Verify `read_only_fields` are defined
- Verify inheritance from `WorkspaceOwnedSerializer`
- Test base serializer functionality

#### 2. API Integration Tests (5 tests)
- Test workspace cannot be assigned via API
- Test workspace cannot be modified via UPDATE
- Test created_by cannot be set via API
- Verify actual user is recorded

#### 3. Edge Case Tests (3 tests)
- Test all affected serializers
- Test multiple models (Dimension, DimensionValue, Rule, String)
- Test both CREATE and UPDATE operations

## Verification Steps

1. ✅ Run new tests: `python manage.py test master_data.tests.test_mass_assignment_prevention`
2. ✅ Run existing tests: Verify no regressions (44 tests passing)
3. ✅ Manual API testing with malicious payloads
4. ✅ Verify audit logs show correct user
5. ✅ Verify workspace isolation maintained

## Attack Mitigation

### Mitigated Attacks

#### 1. Workspace Bypass
**Before**: `POST /api/v1/workspaces/123/dimensions/ {"workspace": 456}` ❌ Success
**After**: `POST /api/v1/workspaces/123/dimensions/ {"workspace": 456}` ✅ Ignored (workspace=123)

#### 2. User Impersonation
**Before**: `POST /api/v1/workspaces/123/dimensions/ {"created_by": 1}` ❌ Admin impersonation
**After**: `POST /api/v1/workspaces/123/dimensions/ {"created_by": 1}` ✅ Ignored (created_by=actual_user)

#### 3. Timestamp Manipulation
**Before**: `POST /api/v1/workspaces/123/dimensions/ {"created": "2020-01-01"}` ❌ Backdated
**After**: `POST /api/v1/workspaces/123/dimensions/ {"created": "2020-01-01"}` ✅ Ignored (created=now)

## Code Examples

### Creating Dimension (Before Fix - Vulnerable)
```bash
POST /api/v1/workspaces/123/dimensions/
{
    "name": "Test Dimension",
    "type": "list",
    "workspace": 456,     # ❌ Bypass workspace isolation
    "created_by": 1       # ❌ Impersonate admin
}

# Response: 201 Created
# ❌ Dimension created in workspace 456 by user 1 (NOT actual user!)
```

### Creating Dimension (After Fix - Secure)
```bash
POST /api/v1/workspaces/123/dimensions/
{
    "name": "Test Dimension",
    "type": "list",
    "workspace": 456,     # ✅ Ignored - read-only field
    "created_by": 1       # ✅ Ignored - read-only field
}

# Response: 201 Created
# ✅ Dimension created in workspace 123 by actual authenticated user
```

## Deployment Notes

- **Breaking Changes**: None - adds additional security
- **Migration Required**: No database changes
- **Client Changes**: No - ignores extra fields gracefully
- **Security Impact**: Closes HIGH severity vulnerability
- **Performance Impact**: None

## Compliance Impact

### Before Fix
- ❌ Non-compliant: Users could falsify audit trails
- ❌ Non-compliant: Authorization bypass possible
- ❌ Risk: Multi-tenant data leakage

### After Fix
- ✅ Compliant: Audit trail integrity maintained
- ✅ Compliant: Authorization enforced
- ✅ Compliant: Multi-tenant isolation preserved

## References

- **CWE-915**: Improperly Controlled Modification of Dynamically-Determined Object Attributes
- **OWASP**: Mass Assignment Cheat Sheet
- **Django REST Framework**: Serializer read_only_fields Documentation
- **GitHub Issue #8**: [AUDIT] [HIGH] Mass Assignment Vulnerability in Serializers

## Related Issues

- **Issue #10**: Missing Workspace Filtering in Dimension Serializer (Fixed)
- **Issue #16**: Dimension Validation Consolidation (Fixed)
- **Issue #37**: Missing Workspace Filtering in String Serializers (Fixed)

## Future Recommendations

1. **Regular Security Audits**: Review new serializers for mass assignment vulnerabilities
2. **Serializer Guidelines**: Document security best practices for new serializers
3. **Code Review Checklist**: Include read_only_fields verification
4. **Automated Testing**: Add CI checks for read_only_fields in workspace-owned serializers

## Summary

Successfully fixed HIGH severity mass assignment vulnerability by:

1. **Created base serializer class** with secure defaults
2. **Updated all affected serializers** to inherit security policy
3. **Verified view enforcement** of system fields
4. **Created comprehensive tests** (12 new tests, 44 existing tests passing)
5. **Documented security patterns** for future development

All tests passing (56/56). Security vulnerability closed. Ready for production deployment.

## Attack Surface Reduction

- **Before**: 4 vulnerable endpoints (Dimension, DimensionValue, Rule, String)
- **After**: 0 vulnerable endpoints - all protected

**Risk Reduced**: HIGH → NONE
